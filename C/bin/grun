#!/usr/bin/bash

# if needed, compile memfd_create.c
mfc=$(dirname "$0")/../memfd_create
if [[ $mfc.c -nt $mfc ]]; then /usr/bin/gcc "$mfc.c" -o "$mfc"; fi

# check for "-run" arg
args=($*)
for((i=0; i<$#; ++i))
do
  if [[ ${args[$i]} == "-run" ]]; then break; fi
done

# in case no "-run" arg found, compile with real compiler
cmp=$(basename "$0")
if [[ $i -ge $# ]]; then "/usr/bin/$cmp" "$@"; exit; fi

# determine language, options for real compiler and src language
if [[ "$cmp" == "gcc" ]]; then lng=c; else lng=c++; fi
opts=${args[*]:0:$i}
shift $((i+1))
src=$1
shift

# for execution as command processor
function shebang() {
  IFS=''

  read -r line
  if [[ ${line:0:2} != "#!" ]]; then echo "$line"; fi

  while read -r line
  do
    echo "$line" 
  done
}

# read memory file name
read -r mf < <($mfc &)

# compile $src, store executable in memory file ...
"/usr/bin/$cmp" $opts -o $mf -x $lng <(shebang < "$src")

# ... and execute it with args
$mf "$@"

# terminate memfd_create.c in order to close memory file
IFS="/"
read -ra mfa <<< "$mf"
kill "${mfa[2]}"
